# Data Resilience Strategy

**Created:** 2025-11-09  
**Status:** ACTIVE  
**Priority:** CRITICAL

## Problem

Data disappeared from production twice in 12 hours due to:
1. Missing `prompts.json` in production deployment
2. MongoDB M0 connection pool exhaustion (80%+ of 500 connection limit)
3. No fallback when both primary JSON and MongoDB failed

## Solution: Triple-Layer Fallback (Optimized for M0 Tier)

### Layer 1: Primary JSON (ISR Cache)
- **Location:** `public/data/prompts.json`, `public/data/patterns.json`
- **Generated by:** Cron job every hour (`/api/cron/regenerate-json`)
- **Freshness:** Max 1 hour old
- **Speed:** Fastest (no DB query)

### Layer 2: Immutable Backup (NEVER FAILS)
- **Location:** `public/data/*-backup.json` (committed to git)
- **When:** Primary JSON missing or stale
- **Updated:** Manually when content changes (rare)
- **Guarantee:** Always deployed, always available
- **Speed:** Fast (just reads file, no network/auth)

### Layer 3: MongoDB (Last Resort)
- **When:** Both primary JSON AND backup fail (extremely rare)
- **Connection:** Aggressive timeouts to prevent pool exhaustion
- **Settings:**
  - `maxPoolSize: 1` (one connection per serverless function)
  - `maxIdleTimeMS: 5000` (close idle connections after 5s)
  - `waitQueueTimeoutMS: 3000` (fail fast if pool exhausted)
- **Why last:** M0 tier is unreliable (hitting 80%+ connection limits)

## Files Protected

| File | Count | Last Updated | Backup |
|------|-------|--------------|--------|
| `prompts.json` | 296 | Nov 8, 2025 | `prompts-backup.json` ✅ |
| `patterns.json` | 18 | Nov 8, 2025 | `patterns-backup.json` ✅ |
| `learning.json` | 20 | Nov 4, 2025 | `learning-backup.json` ✅ |

## MongoDB Connection Limits

**M0 Tier Limits:**
- Max connections: 500 total
- Alert threshold: 80% (400 connections)
- Current strategy: 1 connection per function, close after 5s idle

**If pool exhaustion occurs:**
1. Logs show: `MongoDB connection timeout` or `waitQueueTimeoutMS exceeded`
2. System automatically falls back to immutable backup
3. Site continues working with slightly stale data
4. No user-facing errors

## Backup Strategy

### Automated Backups (Cron)
- **Frequency:** Every hour
- **Location:** `/backups/` directory (local only, not deployed)
- **Retention:** Last 24 hours (24 backups)
- **Script:** `scripts/db/backup-mongodb.ts`

### Immutable Backups (Git)
- **Frequency:** Manual, when content changes
- **Location:** `public/data/*-backup.json` (committed to git)
- **Purpose:** Last-resort fallback that NEVER fails
- **Update process:**
  ```bash
  # After adding/editing prompts or patterns:
  cp public/data/prompts.json public/data/prompts-backup.json
  cp public/data/patterns.json public/data/patterns-backup.json
  git add public/data/*-backup.json
  git commit -m "Update immutable backups"
  ```

## Monitoring

### What to Watch
1. **MongoDB connection alerts** (Atlas sends email at 80%)
2. **Production logs** for "using immutable backup" warnings
3. **Vercel deployment** includes backup files

### Red Flags
- ❌ "CRITICAL: All fallbacks failed" in logs
- ❌ Empty arrays returned (means backup files missing from deployment)
- ❌ MongoDB connection pool consistently above 80%

## Recovery Procedures

### If Data Appears Missing
1. **Check MongoDB first:** Run `pnpm exec tsx scripts/db/backup-mongodb.ts`
2. **Check local JSON:** `ls -lh public/data/*.json`
3. **Check production logs:** Look for fallback warnings
4. **Verify backup files exist:** `ls -lh public/data/*-backup.json`

### If Backup Files Missing from Production
1. Verify they're committed: `git log --oneline public/data/*-backup.json`
2. Redeploy: `git push` (triggers Vercel deployment)
3. Verify in production: Check Vercel deployment logs

### If MongoDB Pool Exhausted
1. Wait 5-10 minutes (connections auto-close)
2. Check Atlas dashboard for connection count
3. If persistent, consider upgrading to M10 tier ($0.08/hr)

## Prevention

### Never Happens Again Because:
1. ✅ **Immutable backups** committed to git (deployed with every build)
2. ✅ **Triple fallback** (JSON → MongoDB → Backup)
3. ✅ **Aggressive connection cleanup** (5s idle timeout)
4. ✅ **Automated hourly backups** (last 24 hours retained)
5. ✅ **Clear logging** at each fallback layer

### Content Update Process
When adding/editing prompts or patterns:
1. Update in MongoDB (via admin UI or script)
2. Regenerate JSON: `pnpm exec tsx scripts/db/generate-prompts-json.ts`
3. Update backup: `cp public/data/prompts.json public/data/prompts-backup.json`
4. Commit backup: `git add public/data/prompts-backup.json && git commit -m "Update backup"`
5. Deploy: `git push`

## Related Files

- `src/lib/prompts/load-prompts-from-json.ts` - Triple fallback logic
- `src/lib/patterns/load-patterns-from-json.ts` - Triple fallback logic
- `src/lib/mongodb.ts` - Connection pool settings
- `scripts/db/backup-mongodb.ts` - Automated backup script
- `public/data/*-backup.json` - Immutable backups (in git)

## Incident History

- **2025-11-09 (Morning):** Data deletion incident, recovered from backup
- **2025-11-09 (Afternoon):** Production JSON missing, MongoDB pool exhausted
- **2025-11-09 (Resolution):** Implemented triple-layer fallback strategy

---

**Rule:** Data NEVER disappears again. If all three layers fail, something is catastrophically wrong with the deployment itself.
