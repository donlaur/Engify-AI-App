#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîí Running pre-commit checks..."
echo ""

# 1. Enterprise compliance check (NEW - CRITICAL)
echo "üè¢ Checking enterprise compliance..."
node scripts/maintenance/check-enterprise-compliance.js
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 2. Schema and code quality validation
echo "üìä Validating schema and code quality..."
node scripts/maintenance/validate-schema.js
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 3. Test framework consistency check (NEW - CRITICAL)
echo "üß™ Checking test framework syntax..."
STAGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.test\.(ts|tsx)$|\.spec\.(ts|tsx)$|__tests__/' || true)
if [ -n "$STAGED_TEST_FILES" ]; then
    node scripts/maintenance/check-test-framework.js $STAGED_TEST_FILES
    if [ $? -ne 0 ]; then
        exit 1
    fi
else
    echo "  No test files to check"
fi
echo ""

# 3.5. Icon validation check (CRITICAL - prevents React error #130)
echo "üé® Checking icon usage and validation..."
STAGED_ICON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' || true)
if [ -n "$STAGED_ICON_FILES" ]; then
    tsx scripts/development/audit-icons.ts
    if [ $? -ne 0 ]; then
        echo "‚ùå Icon validation failed. Fix undefined icons before committing!"
        exit 1
    fi
else
    echo "  No icon-related files to check"
fi
echo ""

# 4. Security checks
echo "üõ°Ô∏è  Checking for security issues..."
node scripts/security/security-check.js
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 5. Check for secrets
echo "üîç Scanning for secrets..."
if command -v git-secrets &> /dev/null; then
    git secrets --scan
    if [ $? -ne 0 ]; then
        exit 1
    fi
else
    echo "‚ö†Ô∏è  git-secrets not installed. Install with: brew install git-secrets"
fi
echo ""

# 6. Lint-staged (formatting, linting)
echo "‚ú® Running linters and formatters..."
pnpm lint-staged
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

echo "‚úÖ All pre-commit checks passed!"
echo ""
