#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîí Running pre-commit checks..."
echo ""

# 0. AI Guardrails Enforcement (NEW - CRITICAL)
echo "üõ°Ô∏è  Enforcing AI guardrails..."
tsx scripts/ai/enforce-guardrails.ts
if [ $? -ne 0 ]; then
    echo "‚ùå Guardrails failed. Review and fix before committing."
    exit 1
fi
echo ""

# 1. Enterprise compliance check (NEW - CRITICAL)
echo "üè¢ Checking enterprise compliance..."
node scripts/maintenance/check-enterprise-compliance.js
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 2. Schema and code quality validation
echo "üìä Validating schema and code quality..."
node scripts/maintenance/validate-schema.js
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 3. Test framework consistency check (NEW - CRITICAL)
echo "üß™ Checking test framework syntax..."
STAGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.test\.(ts|tsx)$|\.spec\.(ts|tsx)$|__tests__/' || true)
if [ -n "$STAGED_TEST_FILES" ]; then
    node scripts/maintenance/check-test-framework.js $STAGED_TEST_FILES
    if [ $? -ne 0 ]; then
        exit 1
    fi
else
    echo "  No test files to check"
fi
echo ""

# 3.25. Run tests for staged test files (NEW - CRITICAL)
echo "üß™ Running tests for staged files..."
if [ -n "$STAGED_TEST_FILES" ] && [ "$SKIP_TESTS" != "true" ]; then
    echo "  Running tests for: $(echo $STAGED_TEST_FILES | tr '\n' ' ')"
    npm run test:run -- $STAGED_TEST_FILES
    if [ $? -ne 0 ]; then
        echo "‚ùå Tests failed. Fix errors before committing."
        echo "   To skip tests (not recommended): SKIP_TESTS=true git commit"
        exit 1
    fi
    echo "  ‚úÖ All tests passed"
else
    if [ "$SKIP_TESTS" = "true" ]; then
        echo "  ‚ö†Ô∏è  Tests skipped (SKIP_TESTS=true)"
    else
        echo "  No test files to run"
    fi
fi
echo ""

# 3.5. Icon validation check (CRITICAL - prevents React error #130)
echo "üé® Checking icon usage and validation..."
STAGED_ICON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' || true)
if [ -n "$STAGED_ICON_FILES" ]; then
    tsx scripts/development/audit-icons.ts
    if [ $? -ne 0 ]; then
        echo "‚ùå Icon validation failed. Fix undefined icons before committing!"
        exit 1
    fi
else
    echo "  No icon-related files to check"
fi
echo ""

# 4. Security checks
echo "üõ°Ô∏è  Checking for security issues..."
node scripts/security/security-check.js
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 5. Check for secrets
echo "üîç Scanning for secrets..."
if command -v git-secrets &> /dev/null; then
    git secrets --scan
    if [ $? -ne 0 ]; then
        exit 1
    fi
else
    echo "‚ö†Ô∏è  git-secrets not installed. Install with: brew install git-secrets"
fi
echo ""

# 6. Lint-staged (formatting, linting)
echo "‚ú® Running linters and formatters..."
pnpm lint-staged
if [ $? -ne 0 ]; then
    exit 1
fi
echo ""

# 6.5. TypeScript type checking (NEW - CRITICAL)
echo "üîç Running TypeScript type check..."
if [ "$SKIP_TYPE_CHECK" != "true" ]; then
    npm run typecheck
    if [ $? -ne 0 ]; then
        echo "‚ùå Type errors found. Fix errors before committing."
        echo "   To skip type check (not recommended): SKIP_TYPE_CHECK=true git commit"
        exit 1
    fi
    echo "  ‚úÖ Type check passed"
else
    echo "  ‚ö†Ô∏è  Type check skipped (SKIP_TYPE_CHECK=true)"
fi
echo ""

echo "‚úÖ All pre-commit checks passed!"
echo ""
